x""" Fichier test pour la caméra"""
import cv2
import time

# On force l'utilisation du backend V4L2 (natif Linux)
cap = cv2.VideoCapture(0, cv2.CAP_V4L2)


# on le format MJPEG d'abord
cap.set(cv2.CAP_PROP_FOURCC, cv2.VideoWriter_fourcc(*'MJPG'))

# on demande le meilleur compromis résolution/fps pour la performance que peut fournir la caméra
cap.set(cv2.CAP_PROP_FRAME_WIDTH, 1280)
cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 720)
cap.set(cv2.CAP_PROP_FPS, 60)

# --- VERIFICATION ---
actual_w = cap.get(cv2.CAP_PROP_FRAME_WIDTH)
actual_h = cap.get(cv2.CAP_PROP_FRAME_HEIGHT)
actual_fps = cap.get(cv2.CAP_PROP_FPS)
print(f"Configuration active : {actual_w}x{actual_h} @ {actual_fps} FPS")

prev_time = time.time()

while True:
    ret, frame = cap.read()
    if not ret:
        break

    # Calcul du FPS réel (logiciel)
    curr_time = time.time()
    real_fps = 1 / (curr_time - prev_time)
    prev_time = curr_time

    # On affiche le FPS sur l'image pour le voir via SSH
    cv2.putText(frame, f"FPS: {real_fps:.1f}", (20, 50), 
                cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 0), 2)

    cv2.imshow("Jetson Camera 720p", frame)

    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
